# To-Be Архитектура системы "Кинобездна"

## Обзор

Целевая архитектура системы "Кинобездна" представляет собой микросервисную архитектуру, построенную на основе доменно-ориентированного проектирования (DDD). Система разделена на несколько ограниченных контекстов (bounded contexts), каждый из которых отвечает за свою бизнес-область.

## Основные принципы архитектуры

1. **Микросервисная архитектура** - система разделена на независимые сервисы
2. **Domain-Driven Design** - выделение доменов на основе бизнес-логики
3. **API Gateway Pattern** - единая точка входа для всех клиентов
4. **Event-Driven Architecture** - асинхронное взаимодействие через события
5. **Service Mesh** - управление межсервисным взаимодействием через Istio
6. **CQRS** - разделение команд и запросов для оптимизации производительности
7. **Saga Pattern** - управление распределенными транзакциями

## Домены системы

### 1. Core Domain - Контент
**Основная бизнес-ценность компании**

#### Movies Service
- Управление метаданными фильмов
- Жанры, актеры, режиссеры
- Рейтинги и оценки
- Технологии: Go, PostgreSQL, Redis

#### Catalog Service
- Формирование каталога контента
- Поиск и фильтрация
- Категоризация контента
- Технологии: Go, Elasticsearch, Redis

#### Streaming Service
- Управление потоковой передачей видео
- Интеграция с CDN
- Управление качеством видео
- Технологии: Go, CDN integration

#### Recommendation Service
- Персонализированные рекомендации
- ML-модели для предсказания предпочтений
- A/B тестирование рекомендаций
- Технологии: Python/Go, ML frameworks

### 2. User Domain - Пользователи
**Управление пользователями и их данными**

#### Auth Service
- Аутентификация (JWT, OAuth 2.0)
- Авторизация (RBAC)
- Управление сессиями
- Технологии: Go, Redis, PostgreSQL

#### User Service
- Управление профилями пользователей
- Персональные данные
- Настройки и предпочтения
- Технологии: Go, PostgreSQL

#### Watch History Service
- История просмотров
- Избранное
- Прогресс просмотра
- Технологии: Go, PostgreSQL, ClickHouse

### 3. Payment Domain - Платежи и подписки
**Монетизация и биллинг**

#### Subscription Service
- Управление подписками
- Планы подписок
- Автопродление
- Технологии: Go, PostgreSQL

#### Payment Service
- Обработка платежей
- Интеграция с платежными шлюзами
- История транзакций
- Технологии: Go, PostgreSQL

#### Billing Service
- Тарификация
- Формирование счетов
- Отчетность
- Технологии: Go, PostgreSQL

#### Discount Service
- Управление скидками
- Промокоды
- Акции и специальные предложения
- Технологии: Go, PostgreSQL, Redis

### 4. Integration Domain - Интеграции
**Взаимодействие с внешними системами**

#### Notification Service
- Email уведомления
- Push-уведомления
- SMS уведомления
- Технологии: Go, Kafka

#### Analytics Service
- Сбор метрик и событий
- Аналитика поведения пользователей
- Бизнес-метрики
- Технологии: Go, ClickHouse, Kafka

#### Integration Adapter
- Интеграция с маркетплейсами
- Интеграция с партнерами
- Интеграция с внешними поставщиками контента
- Технологии: Go, различные API

## Инфраструктурные компоненты

### API Gateway
- Единая точка входа для всех клиентов
- Маршрутизация запросов
- Аутентификация и авторизация
- Rate limiting и throttling
- Backend for Frontend (BFF) паттерн для разных типов клиентов
- Технологии: Go, Kong/Envoy

### Message Broker (Apache Kafka)
- Асинхронная коммуникация между сервисами
- Event sourcing
- Топики:
  - user-events
  - movie-events
  - payment-events
  - notification-events
  - analytics-events

### Базы данных

#### PostgreSQL (основная БД)
- Транзакционные данные
- Пользователи, подписки, платежи
- Метаданные фильмов

#### Redis Cluster
- Кэширование часто запрашиваемых данных
- Сессии пользователей
- Rate limiting счетчики

#### Elasticsearch
- Полнотекстовый поиск
- Индексация каталога
- Поиск по метаданным

#### ClickHouse
- Аналитическая база данных
- Хранение событий
- Построение отчетов

### Service Mesh (Istio)
- Управление межсервисным трафиком
- Circuit Breaker паттерн
- Retry и timeout политики
- Observability (трассировка, метрики)
- Канареечные развертывания

### Мониторинг и логирование
- Prometheus + Grafana для метрик
- ELK Stack для логов
- Jaeger для распределенной трассировки
- Alertmanager для алертов

## Паттерны взаимодействия

### Синхронное взаимодействие
- gRPC для межсервисной коммуникации
- REST API для внешних клиентов
- GraphQL для гибких запросов (опционально)

### Асинхронное взаимодействие
- Event-driven через Kafka
- Saga pattern для распределенных транзакций
- CQRS для разделения команд и запросов

## Миграция с монолита

### Фаза 1: Strangler Fig Pattern
1. Развертывание API Gateway (Proxy Service)
2. Постепенное перенаправление трафика
3. Feature flags для управления миграцией

### Фаза 2: Выделение сервисов
1. Movies Service (уже выделен)
2. User Service
3. Payment Service
4. Subscription Service

### Фаза 3: Полный переход
1. Отключение монолита
2. Оптимизация микросервисов
3. Внедрение advanced patterns

## Преимущества новой архитектуры

1. **Масштабируемость** - независимое масштабирование сервисов
2. **Надежность** - изоляция сбоев, Circuit Breaker
3. **Гибкость** - независимая разработка и деплой
4. **Производительность** - оптимизация под конкретные задачи
5. **Технологическая независимость** - выбор оптимального стека для каждого сервиса

## Диаграммы

- [Контейнерная диаграмма C4 (полная)](c4-container-diagram.puml)
- [Контейнерная диаграмма C4 (упрощенная)](c4-container-simplified.puml)

## Технологический стек

- **Языки программирования**: Go (основной), Python (ML/Analytics)
- **Базы данных**: PostgreSQL, Redis, Elasticsearch, ClickHouse
- **Message Broker**: Apache Kafka
- **Service Mesh**: Istio
- **Container Orchestration**: Kubernetes
- **CI/CD**: GitHub Actions, ArgoCD
- **Monitoring**: Prometheus, Grafana, Jaeger, ELK Stack
- **API Gateway**: Kong/Envoy
- **CDN**: CloudFlare/Akamai
